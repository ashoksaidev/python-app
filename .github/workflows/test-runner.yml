name: build-and-deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

# Use self-hosted runner on the same VM as Vault
env:
  # For dev: hardcode; later switch to repo variable or secret
  VAULT_ADDR: http://127.0.0.1:8212
  APP_NAME: python-app
  IMAGE_NAME: hello-world
  HEALTH_URL: http://localhost:8080/health

concurrency:
  group: pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: ci • build & push
    runs-on: [self-hosted, Linux, X64]
    outputs:
      image_ref: ${{ steps.meta.outputs.image_ref }}
    steps:
      - uses: actions/checkout@v4

      - name: precheck • vault reachability
        run: |
          echo "VAULT_ADDR=${VAULT_ADDR}"
          curl -fsS "${VAULT_ADDR}/v1/sys/health" || (echo "Vault not reachable at ${VAULT_ADDR}" && exit 1)

      - name: vault • read jfrog creds (oidc)
        id: vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ env.VAULT_ADDR }}     # <- fixed: always supplied
          method: jwt
          role: gh-actions               # must match the role you created
          exportEnv: true
          secrets: |
            ci/data/artifactory url          | ART_URL;
            ci/data/artifactory repo_docker  | ART_DOCKER_REPO;
            ci/data/artifactory username     | ART_USER;
            ci/data/artifactory password     | ART_PASS;

      - name: docker • login jfrog
        run: |
          echo "$ART_PASS" | docker login "$ART_URL" -u "$ART_USER" --password-stdin

      - name: meta • compute tags
        id: meta
        run: |
          set -euo pipefail
          TAG_SHA="${{ github.sha }}"
          TAG_BRANCH="${GITHUB_REF##*/}"
          IMAGE_BASE="${ART_URL}/${ART_DOCKER_REPO}/${{ env.IMAGE_NAME }}"
          IMAGE_SHA="${IMAGE_BASE}:${TAG_SHA}"
          IMAGE_BRANCH="${IMAGE_BASE}:${TAG_BRANCH}"
          echo "IMAGE_SHA=$IMAGE_SHA" >> $GITHUB_ENV
          echo "IMAGE_BRANCH=$IMAGE_BRANCH" >> $GITHUB_ENV
          echo "image_ref=$IMAGE_SHA" >> $GITHUB_OUTPUT

      - name: docker • build
        run: |
          docker build -t "$IMAGE_SHA" .
          docker tag "$IMAGE_SHA" "$IMAGE_BRANCH"

      - name: docker • push
        run: |
          docker push "$IMAGE_SHA"
          docker push "$IMAGE_BRANCH"

  cd:
    name: cd • deploy
    runs-on: [self-hosted, Linux, X64]
    needs: ci
    steps:
      - name: precheck • vault reachability
        run: |
          echo "VAULT_ADDR=${VAULT_ADDR}"
          curl -fsS "${VAULT_ADDR}/v1/sys/health" || (echo "Vault not reachable at ${VAULT_ADDR}" && exit 1)

      - name: vault • read jfrog creds (oidc)
        id: vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ env.VAULT_ADDR }}
          method: jwt
          role: gh-actions
          exportEnv: true
          secrets: |
            ci/data/artifactory url          | ART_URL;
            ci/data/artifactory repo_docker  | ART_DOCKER_REPO;
            ci/data/artifactory username     | ART_USER;
            ci/data/artifactory password     | ART_PASS;

      - name: docker • login jfrog
        run: |
          echo "$ART_PASS" | docker login "$ART_URL" -u "$ART_USER" --password-stdin

      - name: deploy • pull & run
        env:
          IMAGE: ${{ needs.ci.outputs.image_ref }}
        run: |
          set -euo pipefail
          docker pull "$IMAGE"
          docker rm -f ${{ env.APP_NAME }} || true
          docker run -d --name ${{ env.APP_NAME }} -p 8080:8080 "$IMAGE"

      - name: post-deploy • health
        run: |
          sleep 3
          curl -fsS "${{ env.HEALTH_URL }}"
          docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"
