name: CI/CD Pipeline for Python Service

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/ci.yml'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Full Docker image tag to deploy'
        required: true
      deploy_target:
        description: 'Deployment target: vm | azure_webapp'
        required: true
        default: 'vm'
      vm_host:
        description: 'VM hostname or IP address'
        required: false
      vm_user:
        description: 'VM SSH username'
        required: false
      azure_resource_group:
        description: 'Azure resource group name'
        required: false

permissions:
  id-token: write
  contents: read

env:
  IMAGE_NAME: python-service
  PYTHON_VERSION: '3.10'
  VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
  VAULT_NAMESPACE: ${{ secrets.VAULT_NAMESPACE }}

jobs:
  build_and_publish_image:
    name: Build, Test, Scan, and Publish Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Set Up Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt pytest

      - name: Run Unit Tests
        run: |
          pytest || RC=$?
          [ "$RC" -eq 5 ] && echo "No tests collected." || ([ "$RC" -ne 0 ] && exit $RC)

      - name: Retrieve Artifactory Credentials from Vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ env.VAULT_ADDR }}
          method: jwt
          path: jwt
          role: gh-actions
          jwtGithubAudience: https://github.com/${{ github.repository_owner }}
          namespace: ${{ env.VAULT_NAMESPACE }}
          exportEnv: true
          secrets: |
            ci/data/artifactory url         | ARTIFACTORY_URL
            ci/data/artifactory repo_docker | DOCKER_REPO
            ci/data/artifactory username    | ARTIFACTORY_USER
            ci/data/artifactory password    | ARTIFACTORY_PASSWORD

      - name: Build Docker Image
        id: build-image
        run: |
          TAG="${IMAGE_NAME}:ci-$(git rev-parse --short HEAD)"
          docker build -t "$TAG" .
          echo "local_image=$TAG" >> $GITHUB_OUTPUT

      - name: Scan Docker Image for Vulnerabilities
        uses: aquasecurity/trivy-action@0.31.0
        with:
          image-ref: ${{ steps.build-image.outputs.local_image }}
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH

      - name: Authenticate with Artifactory
        run: |
          echo "$ARTIFACTORY_PASSWORD" | docker login "$ARTIFACTORY_URL" -u "$ARTIFACTORY_USER" --password-stdin

      - name: Tag and Push Docker Image
        run: |
          TAG="$(git rev-parse --short HEAD)"
          IMAGE="${ARTIFACTORY_URL}/${DOCKER_REPO}/${IMAGE_NAME}:${TAG}"
          docker tag "${{ steps.build-image.outputs.local_image }}" "$IMAGE"
          docker push "$IMAGE"
          echo "$IMAGE" > image-tag.txt

      - name: Save Image Tag
        uses: actions/upload-artifact@v4
        with:
          name: image-tag
          path: image-tag.txt

  deploy_application:
    name: Deploy Docker Image to VM or Azure Web App
    needs: build_and_publish_image
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Retrieve Artifactory Credentials from Vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ env.VAULT_ADDR }}
          method: jwt
          path: jwt
          role: gh-actions
          jwtGithubAudience: https://github.com/${{ github.repository_owner }}
          namespace: ${{ env.VAULT_NAMESPACE }}
          exportEnv: true
          secrets: |
            ci/data/artifactory url         | ARTIFACTORY_URL
            ci/data/artifactory repo_docker | DOCKER_REPO
            ci/data/artifactory username    | ARTIFACTORY_USER
            ci/data/artifactory password    | ARTIFACTORY_PASSWORD

      - name: Authenticate with Artifactory
        run: echo "$ARTIFACTORY_PASSWORD" | docker login "$ARTIFACTORY_URL" -u "$ARTIFACTORY_USER" --password-stdin

      - name: Pull Docker Image
        run: |
          IMAGE="${{ github.event.inputs.image_tag }}"
          [[ "$IMAGE" != */* ]] && IMAGE="${ARTIFACTORY_URL}/${DOCKER_REPO}/${IMAGE}"
          docker pull "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy to Virtual Machine via SSH
        if: ${{ github.event.inputs.deploy_target == 'vm' }}
        run: |
          [[ -z "${{ github.event.inputs.vm_host }}" || -z "${{ github.event.inputs.vm_user }}" ]] && echo "Missing VM host/user" && exit 1
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key "${{ github.event.inputs.vm_user }}@${{ github.event.inputs.vm_host }}" \
            "docker login $ARTIFACTORY_URL -u $ARTIFACTORY_USER -p '$ARTIFACTORY_PASSWORD' && \
             docker pull $IMAGE && \
             docker stop app || true && docker rm app || true && \
             docker run -d --name app -p 80:80 $IMAGE"

      - name: Log In to Azure
        if: ${{ github.event.inputs.deploy_target == 'azure_webapp' }}
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Azure Web App to Use Docker Image
        if: ${{ github.event.inputs.deploy_target == 'azure_webapp' }}
        run: |
          az webapp config container set \
            --name "${{ secrets.AZURE_WEBAPP_NAME }}" \
            --resource-group "${{ github.event.inputs.azure_resource_group || secrets.AZURE_RESOURCE_GROUP }}" \
            --docker-custom-image-name "$IMAGE" \
            --docker-registry-server-url "$ARTIFACTORY_URL" \
            --docker-registry-server-user "$ARTIFACTORY_USER" \
            --docker-registry-server-password "$ARTIFACTORY_PASSWORD"
          az webapp restart \
            --name "${{ secrets.AZURE_WEBAPP_NAME }}" \
            --resource-group "${{ github.event.inputs.azure_resource_group || secrets.AZURE_RESOURCE_GROUP }}"
