# ------------------------------------------------------------
# CI/CD Workflow â€” Authored by Ashok Saidev
# Purpose: Securely deploy a Python service to Azure Web App (Docker Container)
# This workflow uses:
# - Vault OIDC for secrets management
# - JFrog Artifactory for storing Docker images
# - Trivy for scanning vulnerabilities
# ------------------------------------------------------------

name: deploy-python-service

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
  VAULT_NAMESPACE: ${{ secrets.VAULT_NAMESPACE }}
  HEALTHCHECK_URL: https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/status
  IMAGE_NAME: python-service

jobs:
  deploy-artifact:
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up Python environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest

      - name: Run unit tests
        run: |
          pytest || echo "No tests found"

      - name: Decode GitHub OIDC token
        run: |
          TOKEN_URL="${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=https://github.com/${{ github.repository_owner }}"
          IDTOKEN="$(curl -s -H "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" "$TOKEN_URL")"
          PAYLOAD="$(echo "$IDTOKEN" | cut -d '.' -f2 | base64 -d 2>/dev/null)"
          echo "Decoded OIDC token payload:"
          echo "$PAYLOAD" | jq

      - name: Authenticate with Vault
        id: vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: jwt
          path: jwt
          role: gh-actions
          jwtGithubAudience: https://github.com/${{ github.repository_owner }}
          namespace: ${{ secrets.VAULT_NAMESPACE }}
          exportEnv: true
          secrets: |
            ci/data/artifactory url          | ARTIFACTORY_URL;
            ci/data/artifactory repo_docker  | DOCKER_REPO;
            ci/data/artifactory username     | ARTIFACTORY_USER;
            ci/data/artifactory password     | ARTIFACTORY_PASSWORD

      - name: Docker login to JFrog
        run: echo "$ARTIFACTORY_PASSWORD" | docker login "$ARTIFACTORY_URL" -u "$ARTIFACTORY_USER" --password-stdin

      - name: Build Docker image
        run: docker build -t "$IMAGE_NAME:ci" .

      - name: Scan image for vulnerabilities
        run: |
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
          trivy image "$IMAGE_NAME:ci"

      - name: Tag & push image to JFrog
        run: |
          IMAGE_TAG="${ARTIFACTORY_URL}/${DOCKER_REPO}/${IMAGE_NAME}:$(git rev-parse --short HEAD)"
          docker tag "$IMAGE_NAME:ci" "$IMAGE_TAG"
          docker push "$IMAGE_TAG"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy Docker image to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          images: ${{ env.IMAGE_TAG }}

      - name: Post-deployment health check
        run: curl -f $HEALTHCHECK_URL || exit 1
