name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Full Docker image tag to deploy'
        required: true
      deploy_target:
        description: 'Deployment target: vm | azure_webapp'
        required: true
        default: 'vm'
      vm_host:
        description: 'VM hostname or IP address'
        required: false
      vm_user:
        description: 'VM SSH username'
        required: false
      azure_resource_group:
        description: 'Azure resource group name'
        required: false

permissions:
  id-token: write
  contents: read

# Vault env variables available globally
env:
  VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
  VAULT_NAMESPACE: ${{ secrets.VAULT_NAMESPACE }}

jobs:
  deploy_application:
    name: Deploy Docker Image to VM or Azure Web App
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repo
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # Step 2: Retrieve Artifactory credentials from Vault (âœ… Fixed block)
      - name: Retrieve Artifactory Credentials from Vault
        uses: hashicorp/vault-action@v3
        with:
          url: $
