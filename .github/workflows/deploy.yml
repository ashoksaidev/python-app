name: Deploy FastAPI Application

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Full Docker image tag of FastAPI app (built with Chainguard base images, stored in JFrog SaaS)'
        required: true
      deploy_target:
        description: 'Choose where to deploy: vm (Azure VM) | azure_webapp (Azure Web App)'
        required: true
        default: 'vm'
      vm_host:
        description: 'Public IP address of the Azure VM'
        required: false
      vm_user:
        description: 'SSH username for the Azure VM (e.g., azureuser)'
        required: false
      azure_resource_group:
        description: 'Azure Resource Group name (needed only for Web App deploy)'
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  deploy_application:
    name: Build and Deploy FastAPI App
    runs-on: ubuntu-latest

    steps:
      # Step 1. Checkout repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2. Pull JFrog credentials securely from Vault (via GitHub OIDC)
      - name: Get JFrog Credentials from Vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: jwt
          path: jwt
          role: gh-actions
          jwtGithubAudience: https://github.com/ashoksaidev
          exportEnv: true
          secrets: |
            ci/artifactory url | ARTIFACTORY_URL
            ci/artifactory repo_docker | DOCKER_REPO
            ci/artifactory username | ARTIFACTORY_USER
            ci/artifactory password | ARTIFACTORY_PASSWORD

      # Step 3. Authenticate Docker with JFrog
      - name: Docker Login
        run: |
          echo "$ARTIFACTORY_PASSWORD" | docker login "$ARTIFACTORY_URL" -u "$ARTIFACTORY_USER" --password-stdin

      # Step 4. Verify the image tag input
      - name: Validate Image Tag
        run: |
          if [ -z "${{ github.event.inputs.image_tag }}" ]; then
            echo "❌ No image tag provided — please provide one in workflow_dispatch input"
            exit 1
          fi
          echo "image_to_deploy=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
        shell: bash

      # Step 5. Build Docker image for FastAPI
      - name: Build Docker Image
        run: |
          if [ -z "$ARTIFACTORY_URL" ] || [ -z "$DOCKER_REPO" ]; then
            echo "❌ Missing JFrog Artifactory URL or Docker repo"
            exit 1
          fi
          IMAGE="$ARTIFACTORY_URL/$DOCKER_REPO/fastapi-app:${GITHUB_SHA}"
          echo "Building Docker image: $IMAGE"
          docker build -t "$IMAGE" .
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      # Step 6. Push the Docker image to JFrog
      - name: Push Docker Image
        run: docker push $IMAGE

      # Step 7. Deploy to Azure VM (if selected)
      - name: Deploy to Azure VM
        if: ${{ github.event.inputs.deploy_target == 'vm' }}
        run: |
          [[ -z "${{ github.event.inputs.vm_host }}" || -z "${{ github.event.inputs.vm_user }}" ]] && echo "❌ VM host or username not provided" && exit 1
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key "${{ github.event.inputs.vm_user }}@${{ github.event.inputs.vm_host }}" \
            "docker login $ARTIFACTORY_URL -u $ARTIFACTORY_USER -p '$ARTIFACTORY_PASSWORD' && \
             docker pull $IMAGE && \
             docker stop fastapi-app || true && docker rm fastapi-app || true && \
             docker run -d --name fastapi-app -p 80:80 $IMAGE"

      # Step 8. Deploy to Azure Web App (if selected)
      - name: Azure Login
        if: ${{ github.event.inputs.deploy_target == 'azure_webapp' }}
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Web App
        if: ${{ github.event.inputs.deploy_target == 'azure_webapp' }}
        run: |
          az webapp config container set \
            --name "${{ secrets.AZURE_WEBAPP_NAME }}" \
            --resource-group "${{ github.event.inputs.azure_resource_group || secrets.AZURE_RESOURCE_GROUP }}" \
            --docker-custom-image-name "$IMAGE" \
            --docker-registry-server-url "https://$ARTIFACTORY_URL" \
            --docker-registry-server-user "$ARTIFACTORY_USER" \
            --docker-registry-server-password "$ARTIFACTORY_PASSWORD"
          az webapp restart \
            --name "${{ secrets.AZURE_WEBAPP_NAME }}" \
            --resource-group "${{ github.event.inputs.azure_resource_group || secrets.AZURE_RESOURCE_GROUP }}"
