name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Full Docker image tag to deploy'
        required: true
      deploy_target:
        description: 'Deployment target: vm | azure_webapp'
        required: true
        default: 'vm'
      vm_host:
        description: 'VM hostname or IP address'
        required: false
      vm_user:
        description: 'VM SSH username'
        required: false
      azure_resource_group:
        description: 'Azure resource group name'
        required: false

permissions:
  id-token: write
  contents: read

# Global environment variables
env:
  VAULT_ADDR: ${{ secrets.VAULT_ADDR }}

jobs:
  deploy_application:
    name: Deploy Docker Image to VM or Azure Web App
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repo
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # Step 2: Retrieve Artifactory credentials from Vault
      - name: Retrieve Artifactory Credentials from Vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: jwt
          path: jwt
          role: gh-actions
          jwtGithubAudience: https://github.com/ashoksaidev
          exportEnv: true
          secrets: |
            ci/data/artifactory url | ARTIFACTORY_URL
            ci/data/artifactory repo_docker | DOCKER_REPO
            ci/data/artifactory username | ARTIFACTORY_USER
            ci/data/artifactory password | ARTIFACTORY_PASSWORD

      # Step 3: Validate image tag
      - name: Validate Image Tag
        run: |
          if [ -z "${{ github.event.inputs.image_tag }}" ]; then
            echo "❌ No image tag provided — supply via workflow_dispatch input 'image_tag'"
            exit 1
          fi
          echo "image_to_deploy=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
        shell: bash

      # Step 4: Authenticate with Artifactory
      - name: Authenticate with Artifactory
        run: echo "$ARTIFACTORY_PASSWORD" | docker login trialbgccpz.jfrog.io -u "$ARTIFACTORY_USER" --password-stdin

      # ✅ Step 5: Build Docker Image
      - name: Build Docker Image
        run: |
          if [ -z "$ARTIFACTORY_URL" ] || [ -z "$DOCKER_REPO"_]()_]()
