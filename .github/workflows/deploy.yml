name: Deploy FastAPI Application

on:
  push:
    branches:
      - main   # 🚀 Auto deploy whenever code is pushed to main branch

permissions:
  id-token: write
  contents: read

jobs:
  deploy_application:
    name: Deploy Docker Image to VM or Azure Web App
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repo
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # Step 2: Install Vault CLI via HashiCorp APT repo
      - name: Install Vault CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl gnupg lsb-release software-properties-common jq
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update -y
          sudo apt-get install -y vault
          vault --version

      # Step 3: Fetch Artifactory secrets from Vault (KV v2) using CLI
      # Expected keys in secret: url, repo_docker, username, password
      - name: Retrieve Artifactory Credentials from Vault (CLI)
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_NAMESPACE: ${{ secrets.VAULT_NAMESPACE }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
        run: |
          set -euo pipefail
          # Read from KV v2 mount "ci", path "artifactory"
          vault kv get -namespace="$VAULT_NAMESPACE" -mount=ci -format=json artifactory > secret.json

          ARTIFACTORY_URL=$(jq -r '.data.data.url' secret.json)
          DOCKER_REPO=$(jq -r '.data.data.repo_docker' secret.json)
          ARTIFACTORY_USER=$(jq -r '.data.data.username' secret.json)
          ARTIFACTORY_PASSWORD=$(jq -r '.data.data.password' secret.json)

          # Mask sensitive values in logs
          echo "::add-mask::$ARTIFACTORY_PASSWORD"
          echo "::add-mask::$ARTIFACTORY_USER"

          # Export for later steps
          {
            echo "ARTIFACTORY_URL=$ARTIFACTORY_URL"
            echo "DOCKER_REPO=$DOCKER_REPO"
            echo "ARTIFACTORY_USER=$ARTIFACTORY_USER"
            echo "ARTIFACTORY_PASSWORD=$ARTIFACTORY_PASSWORD"
          } >> "$GITHUB_ENV"

      # Step 4: Docker login to JFrog
      - name: Docker Login to JFrog
        run: |
          echo "$ARTIFACTORY_PASSWORD" | docker login "$ARTIFACTORY_URL" -u "$ARTIFACTORY_USER" --password-stdin

      # Step 5: Build FastAPI Docker Image
      - name: Build Docker Image
        run: |
          IMAGE="$ARTIFACTORY_URL/$DOCKER_REPO/fastapi-app:${GITHUB_SHA}"
          echo "Building image: $IMAGE"
          docker build -t "$IMAGE" .
          echo "IMAGE=$IMAGE" >> "$GITHUB_ENV"

      # Step 6: Push Docker image to JFrog
      - name: Push Docker Image to JFrog
        run: docker push "$IMAGE"

      # Step 7: Deploy to Azure VM
      - name: Deploy to Azure VM
        if: always()
        run: |
          [[ -z "${{ secrets.VM_HOST }}" || -z "${{ secrets.VM_USER }}" ]] && echo "❌ Missing VM host/user" && exit 1
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key "${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}" \
            "docker login $ARTIFACTORY_URL -u $ARTIFACTORY_USER -p '$ARTIFACTORY_PASSWORD' && \
             docker pull $IMAGE && \
             (docker stop fastapi-app || true) && (docker rm fastapi-app || true) && \
             docker run -d --name fastapi-app -p 80:80 $IMAGE"

      # Step 8: Deploy to Azure Web App
      - name: Log In to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Azure Web App
        run: |
          az webapp config container set \
            --name "${{ secrets.AZURE_WEBAPP_NAME }}" \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --docker-custom-image-name "$IMAGE" \
            --docker-registry-server-url "https://$ARTIFACTORY_URL" \
            --docker-registry-server-user "$ARTIFACTORY_USER" \
            --docker-registry-server-password "$ARTIFACTORY_PASSWORD"
          az webapp restart \
            --name "${{ secrets.AZURE_WEBAPP_NAME }}" \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}"
